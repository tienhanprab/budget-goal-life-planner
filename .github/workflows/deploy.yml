name: CI / CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# These match your existing project â€” change only if you rename resources.
env:
  GCP_PROJECT_ID: goal-planner-prod-3ffd6
  GCP_REGION: us-central1
  AR_REPO: goal-planner          # Artifact Registry repository name (create once, see SETUP.md)
  IMAGE_NAME: backend
  CLOUD_RUN_SERVICE: goal-planner-backend
  FIREBASE_PROJECT: goal-planner-prod-3ffd6

jobs:

  # â”€â”€ 1. Frontend: lint, type-check, build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  frontend-ci:
    name: Frontend â€” Lint & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        # No VITE_API_URL needed â€” axios.create({ baseURL: '/api/v1' }) uses
        # relative paths; Firebase Hosting rewrites /api/** â†’ Cloud Run.
        run: npm run build

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 1

  # â”€â”€ 2. Deploy Frontend â†’ Firebase Hosting (main only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: Deploy â€” Firebase Hosting
    needs: frontend-ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase Hosting
        run: firebase deploy --only hosting --project ${{ env.FIREBASE_PROJECT }}

  # â”€â”€ 3. PR Preview â†’ Firebase Hosting Preview Channel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  preview-frontend:
    name: Preview â€” Firebase Hosting (PR)
    needs: frontend-ci
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy preview channel
        id: preview
        run: |
          OUTPUT=$(firebase hosting:channel:deploy pr-${{ github.event.pull_request.number }} \
            --project ${{ env.FIREBASE_PROJECT }} \
            --expires 7d \
            --json 2>/dev/null)
          URL=$(echo "$OUTPUT" | jq -r '.result["${{ env.FIREBASE_PROJECT }}"].url')
          echo "url=$URL" >> "$GITHUB_OUTPUT"

      - name: Comment preview URL on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                '### Firebase Hosting Preview',
                '',
                `ðŸ”— **Preview URL:** ${{ steps.preview.outputs.url }}`,
                '',
                '_Expires in 7 days. Re-runs on each push to this PR._'
              ].join('\n')
            })

  # â”€â”€ 4. Build & Deploy Backend â†’ Cloud Run (main only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy â€” Cloud Run
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            --platform linux/amd64 \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:latest \
            ./backend

      - name: Push Docker image
        run: |
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.CLOUD_RUN_SERVICE }} \
            --image ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 0 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --port 8080 \
            --update-env-vars "ENVIRONMENT=production,CORS_ORIGINS=https://budget.tien.codes" \
            --update-secrets "DATABASE_URL=DATABASE_URL:latest,SECRET_KEY=SECRET_KEY:latest"
          # â†‘ Reads DATABASE_URL and SECRET_KEY from GCP Secret Manager.
          # See SETUP.md for how to create them.

      - name: Verify rollout
        run: |
          gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region ${{ env.GCP_REGION }} \
            --format='value(status.conditions[0].status)'
